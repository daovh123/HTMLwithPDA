package org.example.htmlfx.dashboard;

import javafx.animation.KeyFrame;
import javafx.animation.RotateTransition;
import javafx.animation.Timeline;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.scene.chart.LineChart;
import javafx.scene.chart.XYChart;
import javafx.scene.control.Label;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.AnchorPane;
import javafx.stage.Stage;
import javafx.util.Duration;
import org.example.htmlfx.SceneController;
import org.example.htmlfx.SwitchScene;
import org.example.htmlfx.borrow.Borrow_controller;
import org.example.htmlfx.toolkits.DatabaseConnection;
import javafx.scene.control.ListView;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.Slider;
import javafx.scene.layout.VBox;
import org.example.htmlfx.toolkits.MenuEvent;
import org.example.htmlfx.toolkits.Music;
import org.example.htmlfx.user.Member;

import java.io.IOException;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;


public class DashboardControl {
    @FXML
    private TableView<MostBorrowed> tableView;
    @FXML
    private TableColumn<MostBorrowed, Integer> id;
    @FXML
    private TableColumn<MostBorrowed, String> name;
    @FXML
    private TableColumn<MostBorrowed, String> borrowedTimes;
    @FXML
    private LineChart<?, ?> lineChart;
    @FXML
    private Label getIncome;
    @FXML
    AnchorPane toolbar_Pane;
    @FXML
    private ListView<Notification> notificationListView;
    @FXML
    private ImageView settingButton;
    @FXML
    private Label getBorrow;
    @FXML
    private ImageView image;
    @FXML
    private ImageView bell;

    private Music music = new Music();

    private Notification_Service notificationService = new Notification_Service();

    @FXML
    public void initialize() {
        id.setCellValueFactory(new PropertyValueFactory<>("id"));
        name.setCellValueFactory(new PropertyValueFactory<>("name"));
        borrowedTimes.setCellValueFactory(new PropertyValueFactory<>("borrowedTimes"));

        ObservableList<MostBorrowed> data = FXCollections.observableArrayList(DashboardControl.getBorrowed());
        tableView.setItems(data);
        setLineChart();
        setIncome();
        setBorrow();
        //music.play();
        notificationService.start();
        notificationListView.setItems(FXCollections.observableArrayList(notificationService.getNotifications()));
        notificationListView.setVisible(false);
        if(notificationService.getNotifications().isEmpty()) {bellRing();}

        String path = getClass().getResource(SceneController.getAdmin().getImage()).toExternalForm();
        Image temp = new Image(path);
        image.setImage(temp);
    }

    @FXML
    private void checkNotification() {
        // Ki·ªÉm tra tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa ListView
        if (notificationListView.isVisible()) {
            // N·∫øu ListView ƒëang hi·ªÉn th·ªã, ·∫©n n√≥ ƒëi
            notificationListView.setVisible(false);
        } else {
            // N·∫øu ListView ƒëang b·ªã ·∫©n, hi·ªÉn th·ªã n√≥ v√† c·∫≠p nh·∫≠t n·ªôi dung
            ObservableList<Notification> notifications = FXCollections.observableArrayList(notificationService.getNotifications());
            notificationListView.setItems(notifications);
            notificationListView.setVisible(true);
        }
    }

    @FXML
    private void info_admin(MouseEvent event) throws IOException {
        SwitchScene sw = new SwitchScene();
        sw.openNewScene(event, "user/Admin_Edit.fxml", this);
    }

    public static List<MostBorrowed> getBorrowed() {
        List<MostBorrowed> mostBorrowed = new ArrayList<>();
        // S·ª≠a c√¢u truy v·∫•n ƒë·ªÉ l·∫•y 10 cu·ªën s√°ch c√≥ time_of_borrow cao nh·∫•t
        String sql = "SELECT * FROM books ORDER BY time_of_borrow DESC LIMIT 10";
        try (Connection connection = DatabaseConnection.getConnection();
             Statement statement = connection.createStatement();
             ResultSet resultSet = statement.executeQuery(sql)) {
            while (resultSet.next()) {
                String id = resultSet.getString("book_id");
                String name = resultSet.getString("book_name");
                String borrowedTimes = resultSet.getString("time_of_borrow");
                mostBorrowed.add(new MostBorrowed(id, name, borrowedTimes));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return mostBorrowed;
    }

    @FXML
    private void setLineChart() {
        XYChart.Series series = new XYChart.Series<>();
        series.setName("Borrow Count");
        String query = """
                    SELECT 
                        DAYNAME(DATE(borrow_date)) AS day_name, 
                        COUNT(*) AS borrow_count
                    FROM borrow
                    WHERE borrow_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 6 DAY) AND CURDATE()
                    GROUP BY borrow_date
                    ORDER BY DATE(borrow_date);
                """;

        try (Connection conn = DatabaseConnection.getConnection();
             PreparedStatement stmt = conn.prepareStatement(query);
             ResultSet rs = stmt.executeQuery()) {

            // Duy·ªát qua ResultSet ƒë·ªÉ th√™m d·ªØ li·ªáu v√†o series
            while (rs.next()) {
                String dayName = rs.getString("day_name"); // T√™n th·ª©
                int borrowCount = rs.getInt("borrow_count"); // S·ªë l∆∞·ª£t m∆∞·ª£n

                // Th√™m d·ªØ li·ªáu v√†o series
                series.getData().add(new XYChart.Data<>(dayName, borrowCount));
            }

        } catch (Exception e) {
            e.printStackTrace();
        }

        // Th√™m series v√†o LineChart
        lineChart.getData().clear(); // X√≥a d·ªØ li·ªáu c≈© (n·∫øu c√≥)
        lineChart.getData().add(series);
    }

    private void setIncome() {
        double totalPayment = 0.0;
        String sql = "SELECT SUM(price) AS total_payment FROM payment";

        try (Connection connection = DatabaseConnection.getConnection();
             Statement statement = connection.createStatement();
             ResultSet resultSet = statement.executeQuery(sql)) {
            if (resultSet.next()) {
                totalPayment = resultSet.getDouble("total_payment");
            }
        } catch (SQLException e) {
            System.err.println("L·ªói khi truy v·∫•n t·ªïng gi√° tr·ªã payment: " + e.getMessage());
            e.printStackTrace();
        }
        getIncome.setText(String.valueOf(totalPayment) + " VND");
    }

    private void setBorrow() {
        String sql = "SELECT COUNT(*) AS borrow_count FROM borrow WHERE borrow_date = CURDATE()";
        try (Connection connection = DatabaseConnection.getConnection();
             Statement statement = connection.createStatement();
             ResultSet resultSet = statement.executeQuery(sql)) {
            if (resultSet.next()) {
                getBorrow.setText(resultSet.getString("borrow_count"));
            }
        } catch (SQLException e) {
            System.err.println("L·ªói khi truy v·∫•n s·ªë l∆∞·ª£t m∆∞·ª£n s√°ch h√¥m nay: " + e.getMessage());
            e.printStackTrace();
        }
    }

    public void SettingHandle(MouseEvent mouseEvent) {
        // T·∫°o n√∫t b·∫≠t/t·∫Øt nh·∫°c
        Button togglePlayButton = new Button("‚ñ∂ Play");
        togglePlayButton.setStyle("-fx-font-size: 16px; -fx-background-color: #4CAF50; -fx-text-fill: white; -fx-padding: 10px;");
        togglePlayButton.setOnAction(e -> {
            if (music.isPlaying()) {
                music.pause();
                togglePlayButton.setText("‚ñ∂ Play");
                togglePlayButton.setStyle("-fx-font-size: 16px; -fx-background-color: #4CAF50; -fx-text-fill: white;");
            } else {
                music.play();
                togglePlayButton.setText("‚è∏ Pause");
                togglePlayButton.setStyle("-fx-font-size: 16px; -fx-background-color: #44a5ff; -fx-text-fill: white;");
            }
        });

        // N√∫t T·∫Øt ti·∫øng
        Button muteButton = new Button("üîá Mute");
        muteButton.setStyle("-fx-font-size: 16px; -fx-background-color: #44a5ff; -fx-text-fill: white; -fx-padding: 10px;");
        muteButton.setOnAction(e -> {
            if (music.getVolume() > 0) {
                music.setVolume(0);
                muteButton.setText("üîä Unmute");
            } else {
                music.setVolume(0.5); // ƒê·∫∑t √¢m l∆∞·ª£ng v·ªÅ m·ª©c 50% sau khi b·∫≠t l·∫°i
                muteButton.setText("üîá Mute");
            }
        });

        // T·∫°o slider ƒëi·ªÅu ch·ªânh √¢m l∆∞·ª£ng
        Label volumeLabel = new Label("Volume: 50%");
        volumeLabel.setStyle("-fx-font-size: 14px; -fx-text-fill: #333;");
        Slider volumeSlider = new Slider(0, 1, 0.5);
        volumeSlider.setShowTickLabels(true);
        volumeSlider.setShowTickMarks(true);
        volumeSlider.valueProperty().addListener((observable, oldValue, newValue) -> {
            music.setVolume(newValue.doubleValue());
            volumeLabel.setText("Volume: " + Math.round(newValue.doubleValue() * 100) + "%");
        });

        // T·∫°o nh√£n ti√™u ƒë·ªÅ
        Label titleLabel = new Label("üéµ Music Player üéµ");
        titleLabel.setStyle("-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #4CAF50;");

        // CƒÉn ch·ªânh b·ªë c·ª•c
        VBox root = new VBox(20, titleLabel, togglePlayButton, muteButton, volumeLabel, volumeSlider);
        root.setPadding(new Insets(20));
        root.setAlignment(Pos.CENTER);
        root.setStyle("-fx-background-color: linear-gradient(to bottom, #ffffff, #f1f1f1); -fx-border-color: #ccc; -fx-border-width: 2px; -fx-border-radius: 10px; -fx-background-radius: 10px;");

        // T·∫°o Scene v√† thi·∫øt l·∫≠p Stage
        Scene scene = new Scene(root, 400, 350);
        Stage stage = new Stage();
        stage.setScene(scene);
        stage.setTitle("Music Control Settings");
        stage.setOnCloseRequest(e -> music.dispose());
        stage.show();
    }

    @FXML
    private void gotoHome(MouseEvent event) {
        MenuEvent.gotoHome(event);
    }

    @FXML
    private void gotoBook(MouseEvent event) {
        MenuEvent.gotoBook(event);
    }

    @FXML
    private void gotoMember(MouseEvent event) {
        MenuEvent.gotoMember(event);
    }

    @FXML
    private void gotoBorrow(MouseEvent event) {
        MenuEvent.gotoBorrow(event);
    }

    @FXML
    private void gotoIncome(MouseEvent event) {
        MenuEvent.gotoIncome(event);
    }

    @FXML
    private void gotoLogin(MouseEvent event) {
        MenuEvent.gotoLogin(event);
    }

    @FXML
    private void gotoBorrow_temp(MouseEvent event) {
        Borrow_controller.check = false;
        MenuEvent.gotoBorrow(event);
    }

    private void shakeBell() {
        // T·∫°o hi·ªáu ·ª©ng l·∫Øc
        RotateTransition shake = new RotateTransition(Duration.millis(100), bell);
        shake.setFromAngle(-10); // G√≥c b·∫Øt ƒë·∫ßu l·∫Øc
        shake.setToAngle(10);    // G√≥c k·∫øt th√∫c l·∫Øc
        shake.setCycleCount(10);  // 3 l·∫ßn l·∫Øc (6 chu k·ª≥)
        shake.setAutoReverse(true); // T·ª± ƒë·ªông ƒë·∫£o ng∆∞·ª£c g√≥c l·∫Øc
        shake.play();

    }
    private void stopShake() {
        // D·ª´ng hi·ªáu ·ª©ng l·∫Øc v√† ch·ªù 1 gi√¢y
        bell.setRotate(0); // Kh√¥i ph·ª•c g√≥c v·ªÅ 0
    }
    public void bellRing() {
        // T·∫°o Timeline cho l·∫Øc chu√¥ng
        Timeline timeline = new Timeline(
                // L·∫Øc qua l·∫°i trong 3 gi√¢y
                new KeyFrame(Duration.millis(0), e -> shakeBell()),  // B·∫Øt ƒë·∫ßu l·∫Øc ngay l·∫≠p t·ª©c
                new KeyFrame(Duration.millis(1500), e -> stopShake()) // D·ª´ng l·∫Øc sau 3 gi√¢y
        );

        // Sau 3 gi√¢y, ngh·ªâ 1 gi√¢y v√† ti·∫øp t·ª•c l·∫Øc
        timeline.setCycleCount(Timeline.INDEFINITE);
        timeline.play();
    }
}